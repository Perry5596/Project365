# State & Data Rules

## Sources of Truth

- The **single source of truth** for domain objects is the **data layer** (local persistence).
- Zustand stores hold:
  - In-memory views/queries of the data.
  - UI state (selected project, selected date, filters).
- Avoid using component-local state for canonical project/task data.

This is a **React web app**, but the domain/state design should stay UI-agnostic.

## State Shape

In `src/state`:

- `useProjectStore`:
  - State:
    - `projects: Project[]`
    - `selectedProjectId: string | null`
  - Actions:
    - `createProject`
    - `updateProject`
    - `deleteProject`
    - `setSelectedProjectId`

- `useTaskStore`:
  - State:
    - `tasksByProjectId: Record<ProjectId, Task[]>`
  - Actions:
    - `addTask`
    - `addTasks`
    - `updateTask`
    - `deleteTask`
    - `rolloverMissedTasksForDate(date)`
    - `clearMissedTasksForWeek(weekIdentifier)`

- `useSettingsStore`:
  - State:
    - `aiModel`
    - `openAIApiKey`
    - `notificationsEnabled`
    - `notificationTimeOfDay`
    - `theme` (light/dark/system)
  - Actions:
    - `setAiModel`
    - `setOpenAIApiKey`
    - `setNotificationsEnabled`
    - `setNotificationTimeOfDay`
    - `setTheme`

## Data Persistence

Abstract storage in `src/services/storage`:

- `ProjectRepository`
- `TaskRepository`
- `SettingsRepository`

Implementation options (web):

- IndexedDB (via a small wrapper lib or custom implementation).
- localStorage for simple settings (theme, model selection).
- Hide implementation details behind clean interfaces so you can swap later.

## Derived Data

Derived values:

- `daysRemaining(project)`
- `daysBehind(project, taskHistory)`
- `completionRate(projectId, dateRange)`
- `tasksForDate(projectId, date)`
- `missedTasksForCurrentWeek(projectId, date)`

Live in `src/domain/selectors.ts` as pure functions.

Components should **call selectors**, not re-implement logic.

## Schedule & Missed Tasks Logic

- Day definition: use user’s local timezone; treat “day” as midnight–midnight.
- Rollover:
  - At app load (or via explicit daily job), mark any pending tasks whose `date < today` as `missed`.
- Weekly cleanup:
  - When detecting a new week:
    - Clear last week’s missed tasks view (or mark them as expired).
- Weeks:
  - Pick a consistent definition (e.g. ISO week or week starting Monday/Sunday).
  - Document it in code comments and reuse everywhere.

## Cursor Guidance

- When adding new state, prefer extending existing stores over creating many tiny ones.
- Put date calculations & schedule logic in `src/domain`, not inside React components.
- Keep side effects (storage writes, notifications) in `src/services` or dedicated hooks.
