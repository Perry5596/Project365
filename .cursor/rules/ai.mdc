# AI Planning & Agent Rules

## Purpose

These rules govern how we implement:
- Project creation planning.
- Plan regeneration.
- Ongoing AI “agent-like” control over a project’s state.

The AI logic must be **platform-agnostic** and work independently of React or the web.

## Design Principles

- All AI interaction goes through **typed functions** in `src/ai/`.
- Do not send raw internal state to the model without:
  - Filtering to minimal required fields.
  - Respecting user privacy.
- AI outputs must be **pure JSON** that maps to domain types:
  - `AiProjectPlan`
  - `AiPlanUpdate`
  - `AiTaskSuggestions`

## Core Modules

- `src/ai/openaiClient.ts`
  - Wraps the OpenAI SDK.
  - Uses user’s API key from settings.
  - Handles basic errors and timeouts.
- `src/ai/prompts/`
  - `createProjectPlanPrompt.ts`
  - `updatePlanPrompt.ts`
  - `rescheduleFromMissedTasksPrompt.ts`
- `src/ai/types.ts`
  - `AiProjectPlan`, `AiMilestone`, `AiPlannedTask`.
- `src/ai/schemas.ts`
  - Zod schemas for validating model responses.
- `src/ai/planGenerator.ts`
  - `generateInitialPlan(goalInput): Promise<AiProjectPlan>`
  - `regeneratePlan(projectId, instructions): Promise<AiProjectPlan>`
  - `adjustPlanForProgress(projectState, instructions): Promise<AiPlanUpdate>`

## Prompt Structure

Prompts should:

- Explicitly define:
  - Project goal.
  - Timebox (start date, target date, ≤365 days).
  - User constraints (hours per day/week).
- Request a **strict JSON** response:
  - No prose outside JSON.
  - No explanations or commentary.
- Optionally use few-shot examples to clarify schema.

Key instructions to the model:

- “Your job is to produce a plan such that if the user follows every task, it is unreasonable for them to fail.”
- “Break the window into milestones (monthly/quarterly) and daily/weekly tasks.”
- “Each task should be small, actionable, and realistically completable in a day given user constraints.”

## JSON Response Requirements

- Must match Zod schemas in `src/ai/schemas.ts`.
- If parsing/validation fails:
  - Log the error (dev).
  - Show user a simple error message with a retry option.
  - Do not partially apply malformed data.

## Agent-like Control

- Implement as **explicit commands**, not long-lived autonomous agents.
- Example user actions:
  - “Shorten this goal to 120 days.”
  - “Increase difficulty by 20%.”
  - “Change focus from strength to endurance.”
- Flow:
  - Construct `AiPlanCommand` with:
    - Current project snapshot (minimal fields).
    - Explicit user instructions.
    - Constraints (time, difficulty, deadlines).
  - Send to model.
  - Receive `AiPlanUpdate`.
  - Apply via pure functions in `src/domain/planUpdater.ts`.

## Model Selection

- Respect `settings.aiModel` from the settings store.
- Provide:
  - A strong default model for full-plan generation.
  - Lighter/cheaper models for small updates or explanations.
- Implement selection via:
  - `selectModelForTask(taskType: "fullPlan" | "minorUpdate" | "explanation")`.

## No Hidden State

- The model should not rely on hidden state between calls.
- Each call should include all context it needs:
  - Project details.
  - Relevant task history summary.
  - Any user preferences that matter.
